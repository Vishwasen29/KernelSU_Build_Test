name: Build LineageOS OPlus SM8250 Kernel

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  build:
    name: Build Kernel by ${{ github.actor }}
    runs-on: ubuntu-latest

    env:
      CLANG_VERSION: clang-r547379
      GCC_TAG: android-12.1.0_r27
      Lineage_VERSION: lineage-23.0

    steps:
    - name: Checkout source
      uses: actions/checkout@v6

    - name: Set swap to 10G
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 10

    - name: Setup build environment
      run: |
        echo "BUILD_TIME=$(TZ=Asia/Shanghai date '+%y%m%d')" >> $GITHUB_ENV
        echo "BUILD_TIME_1=$(TZ=Asia/Shanghai date '+%Y-%m-%d')" >> $GITHUB_ENV
        sudo apt-get update
        sudo apt-get install -y \
          git ccache automake flex lzop bison gperf build-essential \
          zip curl zlib1g-dev g++-multilib bzip2 libbz2-dev \
          liblz4-tool make squashfs-tools dpkg-dev libssl-dev \
          python3 bc libc6-dev-i386 libncurses5-dev jq
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: Cache Clang toolchain
      id: cache-clang
      uses: actions/cache@v5
      with:
        path: kernel_workspace/clang-aosp
        key: ${{ env.CLANG_VERSION }}

    - name: Download Clang
      if: steps.cache-clang.outputs.cache-hit != 'true'
      run: |
        cd kernel_workspace
        mkdir -p clang-aosp
        wget -O ${CLANG_VERSION}.tar.gz \
          https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/${CLANG_VERSION}.tar.gz
        tar -C clang-aosp -zxvf ${CLANG_VERSION}.tar.gz

    - name: Cache GCC toolchain
      id: cache-gcc
      uses: actions/cache@v4
      with:
        path: kernel_workspace/gcc-64
        key: gcc-aarch64-${{ env.GCC_TAG }}

    - name: Download GCC
      if: steps.cache-gcc.outputs.cache-hit != 'true'
      run: |
        cd kernel_workspace
        mkdir -p gcc-64
        wget -O gcc-aarch64.tar.gz \
          https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/tags/${GCC_TAG}.tar.gz
        tar -C gcc-64 -zxvf gcc-aarch64.tar.gz

    - name: Clone kernel source
      run: |
        cd kernel_workspace
        git clone --recursive \
          https://github.com/LineageOS/android_kernel_oneplus_sm8250 \
          -b ${{ env.Lineage_VERSION }} android-kernel --depth=1

    - name: Setup KernelSU
      run: |
        cd kernel_workspace/android-kernel
        curl -LSs https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh | bash -s main
        bash $GITHUB_WORKSPACE/patches/kernel-4.19_5.4-patch.sh
        echo "CONFIG_KSU_MANUAL_HOOK=y" >> arch/arm64/configs/vendor/kona-perf_defconfig
        KSU_VERSION=$(cd KernelSU && expr $(git rev-list --count HEAD) + 30000)
        echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
        sed -i 's/ -dirty//g' scripts/setlocalversion

    - name: Build kernel
      run: |
        cd kernel_workspace/android-kernel
        export ARCH=arm64
        export SUBARCH=arm64
        export BRAND_SHOW_FLAG=oneplus
        export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang-aosp/bin:$GITHUB_WORKSPACE/kernel_workspace/gcc-64/bin:$PATH
        export KBUILD_BUILD_HOST=Github-Action
        export KBUILD_BUILD_USER=$(echo ${{ github.actor }} | tr A-Z a-z)
        BA_CMD="CLANG_TRIPLE=aarch64-linux-gnu- CROSS_COMPILE=aarch64-linux-android-"
        EX_CMD="LD=ld.lld LLVM=1 LLVM_IAS=1"
        DEFCONFIG="vendor/kona-perf_defconfig vendor/debugfs.config vendor/oplus.config"
        make O=out ARCH=arm64 CC=clang $BA_CMD $EX_CMD $DEFCONFIG
        make -j$(nproc --all) O=out ARCH=arm64 CC=clang $BA_CMD $EX_CMD

    - name: Verify kernel output
      run: |
        cd kernel_workspace/android-kernel/out
        if [ -f arch/arm64/boot/Image ]; then
          echo "CHECK_IMAGE=true" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$(cat include/config/kernel.release)" >> $GITHUB_ENV
        else
          echo "Kernel build failed"
          exit 1
        fi

    - name: Prepare AnyKernel3
      if: env.CHECK_IMAGE == 'true'
      run: |
        cd kernel_workspace
        git clone https://github.com/osm0sis/AnyKernel3 --depth=1
        sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh
        sed -i 's/IS_SLOT_DEVICE=0;/IS_SLOT_DEVICE=auto;/g' AnyKernel3/anykernel.sh
        cp android-kernel/out/arch/arm64/boot/Image AnyKernel3/
        rm -rf AnyKernel3/.git*

    - name: Zip output files
      if: env.CHECK_IMAGE == 'true'
      run: |
        cd kernel_workspace/android-kernel/out/arch/arm64/boot
        zip $GITHUB_WORKSPACE/Image.zip Image
        cd $GITHUB_WORKSPACE/kernel_workspace/AnyKernel3
        zip -r $GITHUB_WORKSPACE/AK3-${{ env.Lineage_VERSION }}-OPlus-SM8250-KSU_${{ env.KSUVER }}-${{ env.BUILD_TIME }}.zip .

    - name: Upload artifacts to GitHub
      if: env.CHECK_IMAGE == 'true'
      uses: actions/upload-artifact@v6
      with:
        name: Kernel-Build
        path: |
          Image.zip
          AK3-${{ env.Lineage_VERSION }}-OPlus-SM8250-KSU_${{ env.KSUVER }}-${{ env.BUILD_TIME }}.zip

    - name: Upload to Google Drive
      if: env.CHECK_IMAGE == 'true'
      env:
        GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        sudo pip3 install google-api-python-client google-auth google-auth-httplib2
        cat > upload.py << 'EOF'
        import json, os
        from google.oauth2.service_account import Credentials
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload

        creds = Credentials.from_service_account_info(
            json.loads(os.environ["GDRIVE_SERVICE_ACCOUNT_JSON"]),
            scopes=["https://www.googleapis.com/auth/drive"]
        )
        service = build("drive", "v3", credentials=creds)
        folder = os.environ["GDRIVE_FOLDER_ID"]

        for f in ["Image.zip",
                  "AK3-${{ env.Lineage_VERSION }}-OPlus-SM8250-KSU_${{ env.KSUVER }}-${{ env.BUILD_TIME }}.zip"]:
            media = MediaFileUpload(f, resumable=True)
            service.files().create(
                body={"name": f, "parents": [folder]},
                media_body=media
            ).execute()
        EOF
        python3 upload.py
