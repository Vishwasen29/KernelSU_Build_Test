name: LineageOS OPlus SM8250 Kernel

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  CLANG_VERSION: clang-r547379
  Lineage_VERSION: lineage-23.2

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set swap to 10G
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10

      - name: Setup build environment
        run: |
          echo "BUILD_TIME=$(TZ=Asia/Shanghai date "+%y%m%d")" >> $GITHUB_ENV
          echo "BUILD_TIME_1=$(TZ=Asia/Shanghai date "+%Y-%m-%d")" >> $GITHUB_ENV

          sudo apt-get update
          sudo apt-get install -y \
            git ccache automake flex lzop bison gperf build-essential zip curl \
            zlib1g-dev g++-multilib bzip2 libbz2-dev liblz4-tool make \
            squashfs-tools dpkg-dev libssl-dev python3 bc libc6-dev-i386 \
            libncurses5-dev

          mkdir -p $GITHUB_WORKSPACE/kernel_workspace

      - name: Cache Clang toolchain
        id: cache-clang
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/kernel_workspace/clang-aosp
          key: ${{ env.CLANG_VERSION }}

      - name: Download Clang (if cache miss)
        if: steps.cache-clang.outputs.cache-hit != 'true'
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          mkdir -p clang-aosp
          wget -O ${CLANG_VERSION}.tar.gz \
            https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/${CLANG_VERSION}.tar.gz
          tar -C clang-aosp -zxvf ${CLANG_VERSION}.tar.gz

      - name: Clone Kernel Source
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          git clone --recursive https://github.com/LineageOS/android_kernel_oneplus_sm8250 \
            -b ${{ env.Lineage_VERSION }} android-kernel --depth=1

      - name: Setup KernelSU (Legacy)
        run: |
          cd kernel_workspace/android-kernel
          #curl -LSs "https://raw.githubusercontent.com/sidex15/KernelSU-Next/legacy-susfs/kernel/setup.sh" | bash -s
          curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s susfs-rksu-master
          bash $GITHUB_WORKSPACE/patches/kernel-4.19_5.4-patch.sh || true
          echo "CONFIG_KSU_MANUAL_HOOK=y" >> arch/arm64/configs/vendor/kona-perf_defconfig
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' security/Kconfig
          RSKSUVER=$(cd KernelSU && expr $(git rev-list --count HEAD) + 30000)
          echo "RSKSUVER=$RSKSUVER" >> $GITHUB_ENV
          sed -i 's/ -dirty//g' scripts/setlocalversion


      - name: Copy SUSFS files
        run: |
          cd kernel_workspace/android-kernel

          #if [ -d "$GITHUB_WORKSPACE/SUSFS" ]; then
            #cp -rp $GITHUB_WORKSPACE/SUSFS/*.c fs/
            #cp -rp $GITHUB_WORKSPACE/SUSFS/*.h include/linux/
          #else
            #echo "SUSFS folder not found!"
            #exit 1
          #fi

          if ! grep -q "susfs.o" fs/Makefile; then
            echo "obj-\$(CONFIG_KSU_SUSFS) += susfs.o" >> fs/Makefile
          fi

      - name: Patch SUSFS symbols
        run: |
          #chmod +x $GITHUB_WORKSPACE/patches/patch_susfs_sym.sh
          #$GITHUB_WORKSPACE/patches/patch_susfs_sym.sh kernel_workspace/android-kernel

      #- name: Apply SUSFS integration (CI safe)
        #run: |
         #cd kernel_workspace/android-kernel
         #chmod +x patches/susfs_fix.sh
         #bash patches/susfs_fix.sh \
         #kernel_workspace/android-kernel \
         #patch -p1 < $GITHUB_WORKSPACE/patches/susfs_patch_to_4.19.patch || true
         #bash $GITHUB_WORKSPACE/patches/susfs_fix1.sh

      - name: Apply SUSFS integration (CI safe)
        run: |
          cd kernel_workspace/android-kernel
          # Apply the main patch (failures ignored)
          patch -p1 < $GITHUB_WORKSPACE/patches/susfs_patch_to_4.19.patch || true

          # Fix include/linux/mount.h with a single-line sed command
          sed -i '/ANDROID_KABI_RESERVE(4)/c#ifdef CONFIG_KSU_SUSFS\n\tANDROID_KABI_USE(4, u64 susfs_mnt_id_backup);\n#else\n\tANDROID_KABI_RESERVE(4);\n#endif' include/linux/mount.h

          # Apply the remaining fix patches (failures ignored)
          patch -p1 < $GITHUB_WORKSPACE/patches/task_mmu.c.patch || true
          patch -p1 < $GITHUB_WORKSPACE/patches/namespace.c.patch || true

      - name: Fail if reject files exist
        run: |
         cd kernel_workspace/android-kernel
         if find . -name "*.rej" | grep -q .; then
          echo "Reject files detected"
          find . -name "*.rej"
          exit 1
         fi
            
      - name: Inject SUSFS Kconfig symbols
        run: |
          chmod +x $GITHUB_WORKSPACE/patches/kconfig.sh
          $GITHUB_WORKSPACE/patches/kconfig.sh kernel_workspace/android-kernel

      
      - name: Add KernelSU & SUSFS configs
        run: |
          cd kernel_workspace/android-kernel
          DEF=arch/arm64/configs/vendor/kona-perf_defconfig

          echo "CONFIG_KSU=y" >> $DEF
          echo "CONFIG_KSU_KPROBES_HOOK=y" >> $DEF
          echo "CONFIG_KSU_SUSFS=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_SUS_SU=y" >> $DEF

      - name: Pre-Build SUSFS Verification
        run: |
          cd kernel_workspace/android-kernel

          if [ ! -f fs/susfs.c ]; then
            echo "❌ susfs.c not found"
            exit 1
          fi

          if [ ! -f include/linux/susfs.h ]; then
            echo "❌ susfs.h not found"
            exit 1
          fi

          if ! grep -q "susfs.o" fs/Makefile; then
            echo "❌ susfs.o missing in Makefile"
            exit 1
          fi

          if ! grep -q "CONFIG_KSU_SUSFS=y" arch/arm64/configs/vendor/kona-perf_defconfig; then
            echo "❌ CONFIG_KSU_SUSFS not in defconfig"
            exit 1
          fi

          if ! grep -rq "config KSU_SUSFS" drivers/ fs/ 2>/dev/null; then
            echo "❌ SUSFS Kconfig symbols not found in source tree"
            exit 1
          fi

          echo "✅ Pre-build verification passed"

      - name: Validate SUSFS config
        run: |
         cd kernel_workspace/android-kernel
         grep CONFIG_KSU_SUSFS .config || exit 1

      - name: Print namespace diff
        run: |
         cd kernel_workspace/android-kernel
         git diff fs/namespace.c

      - name: Build Kernel
        run: |
          cd kernel_workspace/android-kernel

          export ARCH=arm64
          export SUBARCH=arm64
          export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang-aosp/bin:$PATH
          export KBUILD_BUILD_HOST=Github-Action
          export KBUILD_BUILD_USER=$(echo ${{ github.actor }} | tr A-Z a-z)

          # Step 1: Generate base .config from defconfig + oplus fragment.
          # Pipe through "yes ''" to auto-answer any interactive NEW prompts
          # (the previous run showed KSU prompting interactively here).
          yes "" | make O=out CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            LD=ld.lld LLVM=1 \
            vendor/kona-perf_defconfig vendor/oplus.config

          # Step 2: Force-enable all SUSFS options directly into out/.config.
          # Now that the symbols exist in Kconfig, olddefconfig will keep them.
          ./scripts/config --file out/.config \
            --enable CONFIG_KSU \
            --enable CONFIG_KSU_SUSFS \
            --enable CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT \
            --enable CONFIG_KSU_SUSFS_SUS_PATH \
            --enable CONFIG_KSU_SUSFS_SUS_MOUNT \
            --enable CONFIG_KSU_SUSFS_SUS_KSTAT \
            --enable CONFIG_KSU_SUSFS_SUS_OVERLAYFS \
            --enable CONFIG_KSU_SUSFS_TRY_UMOUNT \
            --enable CONFIG_KSU_SUSFS_SPOOF_UNAME \
            --enable CONFIG_KSU_SUSFS_OPEN_REDIRECT \
            --enable CONFIG_KSU_SUSFS_ENABLE_LOG \
            --enable CONFIG_KSU_SUSFS_SUS_SU

          # Step 3: Re-resolve dependencies — symbols are now registered so
          # olddefconfig will honour them rather than strip them.
          make O=out CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            LD=ld.lld LLVM=1 \
            olddefconfig

          # Step 4: Hard assert before the 4-minute compile
          echo "--- SUSFS entries in final .config ---"
          grep "KSU_SUSFS" out/.config || true
          echo "--------------------------------------"

          if ! grep -q "CONFIG_KSU_SUSFS=y" out/.config; then
            echo "❌ CONFIG_KSU_SUSFS was dropped from final .config"
            echo "   KSU_SUSFS depends on KSU — check CONFIG_KSU state:"
            grep "CONFIG_KSU" out/.config || echo "   CONFIG_KSU not found"
            exit 1
          fi

          echo "✅ CONFIG_KSU_SUSFS=y confirmed — starting full build"

          # Step 5: Full build
          make -j$(nproc --all) O=out CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            LD=ld.lld LLVM=1

      - name: Verify Kernel Output
        run: |
          cd kernel_workspace/android-kernel/out
          if [ -f arch/arm64/boot/Image ]; then
            echo "CHECK_IMAGE=true" >> $GITHUB_ENV
            echo "KERNEL_VERSION=$(cat include/config/kernel.release)" >> $GITHUB_ENV
          else
            echo "Kernel build failed"
            exit 1
          fi

      - name: Post-Build SUSFS Verification
        if: env.CHECK_IMAGE == 'true'
        run: |
          cd kernel_workspace/android-kernel

          if ! find out -name "susfs.o" | grep -q susfs.o; then
            echo "❌ susfs.o not compiled"
            exit 1
          fi

          if ! strings out/arch/arm64/boot/Image | grep -i susfs > /dev/null; then
            echo "❌ SUSFS symbol not found in Image"
            exit 1
          fi

          echo "✅ Post-build verification passed"

      - name: Package AnyKernel3
        if: env.CHECK_IMAGE == 'true'
        run: |
          cd kernel_workspace
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh
          sed -i 's!BLOCK=.*!BLOCK=auto;!g' AnyKernel3/anykernel.sh
          sed -i 's/IS_SLOT_DEVICE=0;/IS_SLOT_DEVICE=auto;/g' AnyKernel3/anykernel.sh
          rm -rf AnyKernel3/.git* AnyKernel3/README.md
          cp android-kernel/out/arch/arm64/boot/Image AnyKernel3/
          cd AnyKernel3
          zip -r AK3-${{ env.Lineage_VERSION }}-OPlus-SM8250_KSU_${{ env.RSKSUVER }}.zip ./*

      - name: Upload Kernel Image
        if: env.CHECK_IMAGE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Image
          path: kernel_workspace/android-kernel/out/arch/arm64/boot/Image

      - name: Upload AnyKernel3 ZIP
        if: env.CHECK_IMAGE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: AK3
          path: kernel_workspace/AnyKernel3/*.zip

      - name: Save Build Info
        run: |
          cd kernel_workspace
          {
            echo "KSU_VERSION=${{ env.RSKSUVER }}"
            echo "KERNEL_VERSION=${{ env.KERNEL_VERSION }}"
            echo "BUILD_TIME=${{ env.BUILD_TIME_1 }}"
          } > build-info.txt

      - name: Upload Build Info
        uses: actions/upload-artifact@v4
        with:
          name: Build-Info
          path: kernel_workspace/build-info.txt
