name: LineageOS OPlus SM8250 Kernel

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  CLANG_VERSION: clang-r547379
  Lineage_VERSION: lineage-23.2

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set swap to 10G
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10

      - name: Setup build environment
        run: |
          echo "BUILD_TIME=$(TZ=Asia/Shanghai date "+%y%m%d")" >> $GITHUB_ENV
          echo "BUILD_TIME_1=$(TZ=Asia/Shanghai date "+%Y-%m-%d")" >> $GITHUB_ENV

          sudo apt-get update
          sudo apt-get install -y \
            git ccache automake flex lzop bison gperf build-essential zip curl \
            zlib1g-dev g++-multilib bzip2 libbz2-dev liblz4-tool make \
            squashfs-tools dpkg-dev libssl-dev python3 bc libc6-dev-i386 \
            libncurses5-dev

          mkdir -p $GITHUB_WORKSPACE/kernel_workspace

      - name: Cache Clang toolchain
        id: cache-clang
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/kernel_workspace/clang-aosp
          key: ${{ env.CLANG_VERSION }}

      - name: Download Clang (if cache miss)
        if: steps.cache-clang.outputs.cache-hit != 'true'
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          mkdir -p clang-aosp
          wget -O ${CLANG_VERSION}.tar.gz \
            https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/${CLANG_VERSION}.tar.gz
          tar -C clang-aosp -zxvf ${CLANG_VERSION}.tar.gz

      - name: Clone Kernel Source
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          git clone --recursive https://github.com/LineageOS/android_kernel_oneplus_sm8250 \
            -b ${{ env.Lineage_VERSION }} android-kernel --depth=1

      - name: Setup KernelSU (Legacy)
        run: |
          cd kernel_workspace/android-kernel
          #curl -LSs "https://raw.githubusercontent.com/sidex15/KernelSU-Next/legacy-susfs/kernel/setup.sh" | bash -s
          curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s susfs-rksu-master
          bash $GITHUB_WORKSPACE/patches/kernel-4.19_5.4-patch.sh || true
          echo "CONFIG_KSU_MANUAL_HOOK=y" >> arch/arm64/configs/vendor/kona-perf_defconfig
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' security/Kconfig
          RSKSUVER=$(cd KernelSU-Next && expr $(git rev-list --count HEAD) + 30000)
          echo "RSKSUVER=$RSKSUVER" >> $GITHUB_ENV
          sed -i 's/ -dirty//g' scripts/setlocalversion

      - name: Patch KernelSU for kernel 4.19 compatibility
        run: |
          cd kernel_workspace/android-kernel

          ALLOWLIST=drivers/kernelsu/allowlist.c
          APP_PROFILE=drivers/kernelsu/app_profile.c
          SECCOMP_H=include/linux/seccomp.h

          # Fix 1: TWA_RESUME was introduced in kernel 5.7.
          # On 4.19, task_work_add() takes a plain bool ‚Äî use `true` instead.
          if grep -q "TWA_RESUME" "$ALLOWLIST"; then
            sed -i 's/TWA_RESUME/true/g' "$ALLOWLIST"
            echo "‚úÖ Patched TWA_RESUME ‚Üí true in $ALLOWLIST"
          fi

          # Fix 2: put_task_struct() requires <linux/sched/task.h> on 4.19.
          if ! grep -q "linux/sched/task.h" "$ALLOWLIST"; then
            sed -i '1s|^|#include <linux/sched/task.h>\n|' "$ALLOWLIST"
            echo "‚úÖ Added #include <linux/sched/task.h> to $ALLOWLIST"
          fi

          # Fix 3: struct seccomp has no filter_count on 4.19 ‚Äî it was added
          # later for KernelSU. The patch script targets this but can miss on
          # some tree states, so we patch seccomp.h directly and defensively.
          #
          # We add `atomic_t filter_count;` right after the `int mode;` field
          # inside struct seccomp, guarded by a check so it is idempotent.
          if ! grep -q "filter_count" "$SECCOMP_H"; then
            # Locate the struct seccomp { block and insert after `int mode;`
            sed -i '/^struct seccomp {/{
              :loop
              n
              /int mode;/a\\tatomic_t filter_count;
              /};/b end
              b loop
              :end
            }' "$SECCOMP_H"

            # Verify the patch landed
            if grep -q "filter_count" "$SECCOMP_H"; then
              echo "‚úÖ Added filter_count to struct seccomp in $SECCOMP_H"
            else
              echo "‚ùå sed pattern missed ‚Äî applying fallback patch"
              # Fallback: replace the struct definition wholesale
              python3 - << 'PYEOF'
          import re, pathlib
          h = pathlib.Path("include/linux/seccomp.h")
          txt = h.read_text()
          # Insert atomic_t filter_count; after `int mode;` in struct seccomp
          txt = re.sub(
              r'(struct seccomp \{[^}]*?int mode;)',
              r'\1\n\tatomic_t filter_count;',
              txt, flags=re.DOTALL
          )
          h.write_text(txt)
          PYEOF
              grep -q "filter_count" "$SECCOMP_H" && \
                echo "‚úÖ Fallback patch applied" || \
                { echo "‚ùå Could not patch seccomp.h ‚Äî manual inspection needed"; exit 1; }
            fi
          else
            echo "‚ÑπÔ∏è  filter_count already present in $SECCOMP_H (patch script succeeded)"
          fi

          # Sanity-check: app_profile.c must now be able to find filter_count
          echo "--- struct seccomp in seccomp.h ---"
          grep -A 10 "^struct seccomp {" "$SECCOMP_H" || true
          echo "-----------------------------------"
      - name: Copy SUSFS files
        run: |
          cd kernel_workspace/android-kernel

          if [ -d "$GITHUB_WORKSPACE/SUSFS" ]; then
            cp -rp $GITHUB_WORKSPACE/SUSFS/*.c fs/
            cp -rp $GITHUB_WORKSPACE/SUSFS/*.h include/linux/
          else
            echo "SUSFS folder not found!"
            exit 1
          fi

          if ! grep -q "susfs.o" fs/Makefile; then
            echo "obj-\$(CONFIG_KSU_SUSFS) += susfs.o" >> fs/Makefile
          fi

      - name: Inject SUSFS Kconfig entries
        run: |
          cd kernel_workspace/android-kernel

          # The SUSFS config symbols MUST be declared in the Kconfig tree.
          # Without a declaration, olddefconfig treats them as unknown and
          # silently removes them ‚Äî which is exactly why susfs.o never compiled.
          #
          # We write the Kconfig fragment ourselves since the SUSFS repo does
          # not ship one, then source it from inside the KernelSU driver
          # Kconfig (so "depends on KSU" resolves correctly), falling back to
          # fs/Kconfig if KernelSU has no Kconfig file of its own.

          cat > /tmp/susfs.Kconfig << 'KCONFIG_EOF'
          config KSU_SUSFS
          	bool "Enable SUSFS for KernelSU"
          	depends on KSU
          	default n
          	help
          	  Filesystem spoofing and syscall hook support for KernelSU (SUSFS).

          if KSU_SUSFS

          config KSU_SUSFS_HAS_MAGIC_MOUNT
          	bool "SUSFS: magic mount support"
          	default n

          config KSU_SUSFS_SUS_PATH
          	bool "SUSFS: sus_path"
          	default n

          config KSU_SUSFS_SUS_MOUNT
          	bool "SUSFS: sus_mount"
          	default n

          config KSU_SUSFS_SUS_KSTAT
          	bool "SUSFS: sus_kstat"
          	default n

          config KSU_SUSFS_SUS_OVERLAYFS
          	bool "SUSFS: sus_overlayfs"
          	default n

          config KSU_SUSFS_TRY_UMOUNT
          	bool "SUSFS: try_umount"
          	default n

          config KSU_SUSFS_SPOOF_UNAME
          	bool "SUSFS: spoof_uname"
          	default n

          config KSU_SUSFS_OPEN_REDIRECT
          	bool "SUSFS: open_redirect"
          	default n

          config KSU_SUSFS_ENABLE_LOG
          	bool "SUSFS: enable logging"
          	default n

          config KSU_SUSFS_SUS_SU
          	bool "SUSFS: sus_su"
          	default n

          endif # KSU_SUSFS
          KCONFIG_EOF

          # Prefer to attach to the KernelSU Kconfig so the dependency chain
          # (KSU_SUSFS depends on KSU) resolves in the correct menu context.
          KSU_KCONFIG=$(find drivers/kernelsu -name Kconfig 2>/dev/null | head -1)

          if [ -n "$KSU_KCONFIG" ]; then
            TARGET_DIR=$(dirname "$KSU_KCONFIG")
            TARGET_KCONFIG="$KSU_KCONFIG"
            echo "üìã Attaching SUSFS Kconfig to KernelSU: $TARGET_KCONFIG"
          else
            TARGET_DIR="fs"
            TARGET_KCONFIG="fs/Kconfig"
            echo "üìã KernelSU Kconfig not found ‚Äî attaching SUSFS to fs/Kconfig"
          fi

          cp /tmp/susfs.Kconfig "${TARGET_DIR}/susfs.Kconfig"

          # Avoid duplicate sourcing on re-runs
          if ! grep -q "susfs.Kconfig" "$TARGET_KCONFIG"; then
            echo "source \"${TARGET_DIR}/susfs.Kconfig\"" >> "$TARGET_KCONFIG"
          fi

          echo "‚úÖ SUSFS Kconfig injected into $TARGET_KCONFIG"
          echo "--- Verifying symbols are reachable ---"
          grep -r "config KSU_SUSFS" "${TARGET_DIR}/" || true

      - name: Add KernelSU & SUSFS configs
        run: |
          cd kernel_workspace/android-kernel
          DEF=arch/arm64/configs/vendor/kona-perf_defconfig

          echo "CONFIG_KSU=y" >> $DEF
          echo "CONFIG_KSU_KPROBES_HOOK=y" >> $DEF
          echo "CONFIG_KSU_SUSFS=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> $DEF
          echo "CONFIG_KSU_SUSFS_SUS_SU=y" >> $DEF

      - name: Pre-Build SUSFS Verification
        run: |
          cd kernel_workspace/android-kernel

          if [ ! -f fs/susfs.c ]; then
            echo "‚ùå susfs.c not found"
            exit 1
          fi

          if [ ! -f include/linux/susfs.h ]; then
            echo "‚ùå susfs.h not found"
            exit 1
          fi

          if ! grep -q "susfs.o" fs/Makefile; then
            echo "‚ùå susfs.o missing in Makefile"
            exit 1
          fi

          if ! grep -q "CONFIG_KSU_SUSFS=y" arch/arm64/configs/vendor/kona-perf_defconfig; then
            echo "‚ùå CONFIG_KSU_SUSFS not in defconfig"
            exit 1
          fi

          if ! grep -rq "config KSU_SUSFS" drivers/ fs/ 2>/dev/null; then
            echo "‚ùå SUSFS Kconfig symbols not found in source tree"
            exit 1
          fi

          echo "‚úÖ Pre-build verification passed"

      - name: Build Kernel
        run: |
          cd kernel_workspace/android-kernel

          export ARCH=arm64
          export SUBARCH=arm64
          export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang-aosp/bin:$PATH
          export KBUILD_BUILD_HOST=Github-Action
          export KBUILD_BUILD_USER=$(echo ${{ github.actor }} | tr A-Z a-z)

          # Step 1: Generate base .config from defconfig + oplus fragment.
          # Pipe through "yes ''" to auto-answer any interactive NEW prompts
          # (the previous run showed KSU prompting interactively here).
          yes "" | make O=out CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            LD=ld.lld LLVM=1 \
            vendor/kona-perf_defconfig vendor/oplus.config

          # Step 2: Force-enable all SUSFS options directly into out/.config.
          # Now that the symbols exist in Kconfig, olddefconfig will keep them.
          ./scripts/config --file out/.config \
            --enable CONFIG_KSU \
            --enable CONFIG_KSU_SUSFS \
            --enable CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT \
            --enable CONFIG_KSU_SUSFS_SUS_PATH \
            --enable CONFIG_KSU_SUSFS_SUS_MOUNT \
            --enable CONFIG_KSU_SUSFS_SUS_KSTAT \
            --enable CONFIG_KSU_SUSFS_SUS_OVERLAYFS \
            --enable CONFIG_KSU_SUSFS_TRY_UMOUNT \
            --enable CONFIG_KSU_SUSFS_SPOOF_UNAME \
            --enable CONFIG_KSU_SUSFS_OPEN_REDIRECT \
            --enable CONFIG_KSU_SUSFS_ENABLE_LOG \
            --enable CONFIG_KSU_SUSFS_SUS_SU

          # Step 3: Re-resolve dependencies ‚Äî symbols are now registered so
          # olddefconfig will honour them rather than strip them.
          make O=out CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            LD=ld.lld LLVM=1 \
            olddefconfig

          # Step 4: Hard assert before the 4-minute compile
          echo "--- SUSFS entries in final .config ---"
          grep "KSU_SUSFS" out/.config || true
          echo "--------------------------------------"

          if ! grep -q "CONFIG_KSU_SUSFS=y" out/.config; then
            echo "‚ùå CONFIG_KSU_SUSFS was dropped from final .config"
            echo "   KSU_SUSFS depends on KSU ‚Äî check CONFIG_KSU state:"
            grep "CONFIG_KSU" out/.config || echo "   CONFIG_KSU not found"
            exit 1
          fi

          echo "‚úÖ CONFIG_KSU_SUSFS=y confirmed ‚Äî starting full build"

          # Step 5: Full build
          make -j$(nproc --all) O=out CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            LD=ld.lld LLVM=1

      - name: Verify Kernel Output
        run: |
          cd kernel_workspace/android-kernel/out
          if [ -f arch/arm64/boot/Image ]; then
            echo "CHECK_IMAGE=true" >> $GITHUB_ENV
            echo "KERNEL_VERSION=$(cat include/config/kernel.release)" >> $GITHUB_ENV
          else
            echo "Kernel build failed"
            exit 1
          fi

      - name: Post-Build SUSFS Verification
        if: env.CHECK_IMAGE == 'true'
        run: |
          cd kernel_workspace/android-kernel

          if ! find out -name "susfs.o" | grep -q susfs.o; then
            echo "‚ùå susfs.o not compiled"
            exit 1
          fi

          if ! strings out/arch/arm64/boot/Image | grep -i susfs > /dev/null; then
            echo "‚ùå SUSFS symbol not found in Image"
            exit 1
          fi

          echo "‚úÖ Post-build verification passed"

      - name: Package AnyKernel3
        if: env.CHECK_IMAGE == 'true'
        run: |
          cd kernel_workspace
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh
          sed -i 's!BLOCK=.*!BLOCK=auto;!g' AnyKernel3/anykernel.sh
          sed -i 's/IS_SLOT_DEVICE=0;/IS_SLOT_DEVICE=auto;/g' AnyKernel3/anykernel.sh
          rm -rf AnyKernel3/.git* AnyKernel3/README.md
          cp android-kernel/out/arch/arm64/boot/Image AnyKernel3/
          cd AnyKernel3
          zip -r AK3-${{ env.Lineage_VERSION }}-OPlus-SM8250_KSU_${{ env.RSKSUVER }}.zip ./*

      - name: Upload Kernel Image
        if: env.CHECK_IMAGE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Image
          path: kernel_workspace/android-kernel/out/arch/arm64/boot/Image

      - name: Upload AnyKernel3 ZIP
        if: env.CHECK_IMAGE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: AK3
          path: kernel_workspace/AnyKernel3/*.zip

      - name: Save Build Info
        run: |
          cd kernel_workspace
          {
            echo "KSU_VERSION=${{ env.RSKSUVER }}"
            echo "KERNEL_VERSION=${{ env.KERNEL_VERSION }}"
            echo "BUILD_TIME=${{ env.BUILD_TIME_1 }}"
          } > build-info.txt

      - name: Upload Build Info
        uses: actions/upload-artifact@v4
        with:
          name: Build-Info
          path: kernel_workspace/build-info.txt
