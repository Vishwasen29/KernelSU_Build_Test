name: KSUN + SUSFS LineageOS SM8250

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  CLANG_VERSION: clang-r547379
  LINEAGE_VERSION: lineage-23.2

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup swap
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 10

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git ccache automake flex lzop bison gperf build-essential \
          zip curl zlib1g-dev g++-multilib bzip2 libbz2-dev liblz4-tool \
          make squashfs-tools dpkg-dev libssl-dev python3 bc \
          libc6-dev-i386 libncurses5-dev wget

        mkdir -p kernel_workspace

    - name: Download Clang
      run: |
        cd kernel_workspace
        mkdir clang
        wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/${CLANG_VERSION}.tar.gz -O clang.tar.gz
        tar -xf clang.tar.gz -C clang

    - name: Clone Kernel Source
      run: |
        cd kernel_workspace
        git clone --depth=1 \
          https://github.com/LineageOS/android_kernel_oneplus_sm8250 \
          -b $LINEAGE_VERSION android-kernel

    # -------------------------------------------------------
    # FIXED KERNELSU + LEGACY-SUSFS INTEGRATION
    # -------------------------------------------------------
    - name: Setup KernelSU-Next (legacy-susfs)
      run: |
        cd kernel_workspace/android-kernel

        # Clone correct repo (NOT official)
        git clone https://github.com/sidex15/KernelSU-Next.git
        cd KernelSU-Next
        git checkout legacy-susfs
        cd ..

        # Symlink into drivers
        ln -sf ../KernelSU-Next/kernel drivers/kernelsu

        # Add Makefile entry safely
        grep -q "kernelsu" drivers/Makefile || \
          echo 'obj-$(CONFIG_KSU) += kernelsu/' >> drivers/Makefile

        # Add Kconfig entry safely
        grep -q 'drivers/kernelsu/Kconfig' drivers/Kconfig || \
          sed -i '/endmenu/i\source "drivers/kernelsu/Kconfig"' drivers/Kconfig

        # Remove dirty tag
        sed -i 's/ -dirty//g' scripts/setlocalversion

        # Generate KSU version
        RSKSUVER=$(cd KernelSU-Next && expr $(git rev-list --count HEAD) + 30000)
        echo "RSKSUVER=$RSKSUVER" >> $GITHUB_ENV

    # -------------------------------------------------------
    # APPLY SUSFS PATCH
    # -------------------------------------------------------
    - name: Apply SUSFS patch
      run: |
        cd kernel_workspace/android-kernel
        set -o pipefail
        patch -p1 --forward \
          < $GITHUB_WORKSPACE/patches/susfs_patch_to_4.19.patch \
          2>&1 | tee patch_log.txt || true

    # -------------------------------------------------------
    # ENABLE CONFIGS
    # -------------------------------------------------------
    - name: Enable KernelSU + SUSFS configs
      run: |
        cd kernel_workspace/android-kernel
        DEF=arch/arm64/configs/vendor/kona-perf_defconfig

        {
          echo "CONFIG_KSU=y"
          echo "CONFIG_KSU_MANUAL_HOOK=y"
          echo "CONFIG_KSU_SUSFS=y"
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y"
          echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y"
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y"
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y"
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y"
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y"
          echo "CONFIG_KSU_SUSFS_SUS_SU=y"
        } >> $DEF

    # -------------------------------------------------------
    # BUILD
    # -------------------------------------------------------
    - name: Build Kernel
      run: |
        cd kernel_workspace/android-kernel

        export ARCH=arm64
        export SUBARCH=arm64
        export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang/bin:$PATH
        export KBUILD_BUILD_USER=github
        export KBUILD_BUILD_HOST=actions

        make O=out CC=clang LLVM=1 vendor/kona-perf_defconfig
        make -j$(nproc --all) O=out CC=clang LLVM=1

    - name: Verify Image
      run: |
        cd kernel_workspace/android-kernel/out
        test -f arch/arm64/boot/Image

    # -------------------------------------------------------
    # PACKAGE AK3
    # -------------------------------------------------------
    - name: Build AnyKernel3 ZIP
      run: |
        cd kernel_workspace
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3
        rm -rf AnyKernel3/.git*
        cp android-kernel/out/arch/arm64/boot/Image AnyKernel3/

        cd AnyKernel3
        zip -r KSUN-SUSFS-${{ env.RSKSUVER }}.zip ./*

    - name: Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: KSUN-SUSFS
        path: kernel_workspace/AnyKernel3/*.zip
